<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¬ë‚œÂ·ì‹¬ë¦¬ìƒë‹´ ê¸´ê¸‰ ì§€ì› ì‹œìŠ¤í…œ</title>

    <!-- ìŠ¤íƒ€ì¼ -->
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f2f4f7;
        }

        header {
            background: #1f6feb;
            padding: 15px;
            color: white;
            font-size: 20px;
            text-align: center;
            font-weight: bold;
        }

        .menu-container {
            display: flex;
            justify-content: space-around;
            margin: 20px 10px;
        }

        .menu-btn {
            background: white;
            border-radius: 12px;
            padding: 15px;
            width: 30%;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        .menu-btn:hover {
            background: #e7ecf3;
        }

        #map {
            height: 300px;
            margin: 0 10px;
            border-radius: 12px;
            overflow: hidden;
        }

        #chatbox {
            margin: 20px 10px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        #messages {
            height: 180px;
            overflow-y: auto;
            padding: 10px;
            background: #f7f7f7;
            border-radius: 8px;
        }

        .msg-user {
            background: #d0e2ff;
            padding: 8px;
            margin: 6px;
            border-radius: 8px;
            text-align: right;
        }

        .msg-bot {
            background: #fff5cc;
            padding: 8px;
            margin: 6px;
            border-radius: 8px;
            text-align: left;
        }

        #input-area {
            display: flex;
            margin-top: 10px;
        }

        #chat-input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        #send-btn {
            padding: 10px 15px;
            margin-left: 8px;
            background: #1f6feb;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        #send-btn:hover {
            background: #155acb;
        }
    </style>

    <!-- Leaflet ì§€ë„ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>

<header>
    ì¬ë‚œÂ·ì‹¬ë¦¬ìƒë‹´ ê¸´ê¸‰ ì§€ì› ì‹œìŠ¤í…œ
</header>

<div class="menu-container">
    <div class="menu-btn" id="btn-shelter">ğŸ¥ ëŒ€í”¼ì†Œ ì •ë³´</div>
    <div class="menu-btn">ğŸš§ ë„ë¡œ í†µì œ</div>
    <div class="menu-btn">ğŸ“¢ ì¬ë‚œ ì•Œë¦¼</div>
</div>

<div id="map"></div>

<div id="chatbox">
    <h3>ğŸ§‘â€âš•ï¸ ì‹¬ë¦¬ ìƒë‹´ ì±—ë´‡</h3>
    <div id="messages"></div>

    <div id="input-area">
        <input type="text" id="chat-input" placeholder="ì–´ë–¤ ìƒí™©ì¸ê°€ìš”?" />
        <button id="send-btn" onclick="sendMessage()">ì „ì†¡</button>
    </div>
</div>

<script>
    /* ============================
       0) ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •
       ============================ */
    const WORKER_BASE = "https://YOUR_WORKER_URL.workers.dev";  // âš ï¸ ì—¬ê¸°ë¥¼ ë„¤ Worker ê¸°ë³¸ ì£¼ì†Œë¡œ ë³€ê²½

    const CHAT_ENDPOINT = `${WORKER_BASE}/chatbot`;
    const SHELTER_API   = `${WORKER_BASE}/shelters`;

    /* ============================
       1) ì•„ì´ì½˜ ì„¤ì • (í˜„ì¬ ìœ„ì¹˜ vs ëŒ€í”¼ì†Œ)
       ============================ */
    const userIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
        iconSize:     [25, 41],
        iconAnchor:   [12, 41],
        popupAnchor:  [1, -34],
        shadowSize:   [41, 41]
    });

    const shelterIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
        iconSize:     [25, 41],
        iconAnchor:   [12, 41],
        popupAnchor:  [1, -34],
        shadowSize:   [41, 41]
    });

    /* ============================
       2) ì§€ë„ ì´ˆê¸°í™”
       ============================ */
    var map = L.map('map').setView([37.5665, 126.9780], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
    }).addTo(map);

    // íŒŒë€ìƒ‰ = í˜„ì¬ ìœ„ì¹˜(ê¸°ë³¸)
    var baseMarker = L.marker([37.5665, 126.9780], { icon: userIcon }).addTo(map)
        .bindPopup("í˜„ì¬ ìœ„ì¹˜ (ê¸°ë³¸ê°’: ì„œìš¸ ì‹œì²­ ê·¼ì²˜)")
        .openPopup();

    let shelterMarkers = [];

    function clearShelters() {
        shelterMarkers.forEach(m => map.removeLayer(m));
        shelterMarkers = [];
    }

    async function loadRealShelters() {
        clearShelters();
        try {
            const res = await fetch(SHELTER_API);
            const data = await res.json();

            (data.shelters || []).forEach(s => {
                const m = L.marker([s.lat, s.lon], { icon: shelterIcon })
                    .addTo(map)
                    .bindPopup(`<b>${s.name}</b><br>${s.address}`);
                shelterMarkers.push(m);
            });

            if ((data.shelters || []).length === 0) {
                alert("ëŒ€í”¼ì†Œ ë°ì´í„° ì—†ìŒ");
            }
        } catch (e) {
            console.error(e);
            alert("ëŒ€í”¼ì†Œ ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
        }
    }

    document.getElementById("btn-shelter").onclick = loadRealShelters;

    /* ============================
       3) ì±—ë´‡ ê¸°ëŠ¥
       ============================ */
    function addMessage(text, sender) {
        const messages = document.getElementById("messages");
        const div = document.createElement("div");
        div.className = sender === "user" ? "msg-user" : "msg-bot";
        div.innerText = text;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById("chat-input");
        const message = input.value.trim();
        if (!message) return;

        addMessage(message, "user");
        input.value = "";

        try {
            const res = await fetch(CHAT_ENDPOINT, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message })
            });

            const data = await res.json();
            addMessage(data.reply, "bot");
        } catch (e) {
            console.error(e);
            addMessage("ì„œë²„ ì˜¤ë¥˜! ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", "bot");
        }
    }
</script>

</body>
</html>
